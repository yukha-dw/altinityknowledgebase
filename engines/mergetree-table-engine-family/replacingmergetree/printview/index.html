<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=http://kb.altinity.com/engines/mergetree-table-engine-family/replacingmergetree/><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=icon href=/favicons/favicon.ico><title>ReplacingMergeTree | Altinity Knowledge Base</title>
<meta name=description content="ReplacingMergeTree
"><meta property="og:url" content="http://kb.altinity.com/engines/mergetree-table-engine-family/replacingmergetree/"><meta property="og:site_name" content="Altinity Knowledge Base"><meta property="og:title" content="ReplacingMergeTree"><meta property="og:description" content="ReplacingMergeTree"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="ReplacingMergeTree"><meta itemprop=description content="ReplacingMergeTree"><meta itemprop=dateModified content="2024-02-01T14:27:51-05:00"><meta itemprop=wordCount content="1301"><meta name=twitter:card content="summary"><meta name=twitter:title content="ReplacingMergeTree"><meta name=twitter:description content="ReplacingMergeTree"><link rel=preload href=/scss/main.min.0540caa2be9636e844abdc4074ccc95d5ea7d1bdb6b14eebc9aca32f58b2db3b.css as=style><link href=/scss/main.min.0540caa2be9636e844abdc4074ccc95d5ea7d1bdb6b14eebc9aca32f58b2db3b.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><link rel=stylesheet href=/css/prism.css><meta name=keywords content><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="a" viewBox="0 0 91.660006 105.99" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1"><style id="style1">.b{fill:#fff}.c{fill:#199dcf}</style></defs><g id="g7"><polygon class="c" points="45.88,0 45.88,0.04 22.94,13.3 22.93,13.3 22.93,13.3 0.09,26.49 0.09,26.49 0.09,26.49 0,26.54 0.09,26.59 0.09,50.96 66.86,12.12" id="polygon1"/><polygon class="c" points="22.94,42.29 4.21,53.19 22.94,64.08" id="polygon2"/><polygon class="c" points="0.09,55.59 0.09,79.43 0,79.48 0.09,79.54 0.09,105.99 22.8,92.88 22.8,92.88 43.75,80.79 0.23,55.51" id="polygon3"/><polygon class="c" points="89.61,25.17 70.92,14.38 48.03,27.7 64.18,37.02 64.22,36.96 66.79,38.45" id="polygon4"/><g id="g6"><polygon class="c" points="91.66,52.82 91.63,52.83 76.33,44 91.66,52.92" id="polygon5"/><polygon class="c" points="91.66,105.76 91.66,57.55 68.71,44.2 68.71,92.51" id="polygon6"/></g><polygon class="c" points="91.66,52.85 91.66,28.61 70.77,40.76 76.28,43.97" id="polygon7"/></g></svg></span><span class=font-weight-bold>Altinity Knowledge Base</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=productsDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Products</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=https://altinity.com/managed-clickhouse/ target=_blank><span style=font-size:large>Altinity.Cloud</span><br><span style=font-size:small>Managed service for ClickHouse in any AWS, GCP, or Azure region or your own VPC</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-support/ target=_blank><span style=font-size:large>Support for ClickHouse</span><br><span style=font-size:small>Get 24/7 Support or POC and evaluative support</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-training/ target=_blank><span style=font-size:large>Training for ClickHouse</span><br><span style=font-size:small>Altinity Administrator training for ClickHouse</span></a>
<a class=dropdown-item href=https://altinity.com/customer-stories/ target=_blank><span style=font-size:large>Customer Stories</span><br><span style=font-size:small>See why our customers love us</span></a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=resourceDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Resources</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=https://docs.altinity.com/ target=_blank><span style=font-size:large>Documentation</span><br><span style=font-size:small>Product guides and tutorials</span></a>
<a class=dropdown-item href=https://hubs.la/Q02pLTV20 target=_blank><span style=font-size:large>Guides and eBooks</span><br><span style=font-size:small>Technical content for developers</span></a>
<a class=dropdown-item href=https://altinity.com/clickhouse-database/ target=_blank><span style=font-size:large>What is ClickHouse?</span><br><span style=font-size:small>Learn why ClickHouse is the fastest database in the world</span></a>
<a class=dropdown-item href=https://altinity.com/what-is-kubernetes/ target=_blank><span style=font-size:large>What is Kubernetes?</span><br><span style=font-size:small>Learn why Kubernetes is the platform of choice for analytic databases</span></a></div></li><li class=nav-item><a class=nav-link href=https://altinity.com/blog target=_blank>Blog <span class=navbar-logo><svg width="25.897644" height="31.648945" viewBox="0 0 25.897644 31.648945" id="svg1" xmlns="http://www.w3.org/2000/svg"><path d="m18 14.5v6H6v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#fff" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round" id="path1" style="stroke:#fff;stroke-opacity:1"/></svg></span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=companyDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Company</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=https://altinity.com/about-us/ target=_blank><span style=font-size:large>About the Company</span><br><span style=font-size:small>Who we are and what we do</span></a>
<a class=dropdown-item href=https://altinity.com/careers/ target=_blank><span style=font-size:large>Careers</span><br><span style=font-size:small>Join our team!</span></a>
<a class=dropdown-item href=https://altinity.com/contact target=_blank><span style=font-size:large>Contact</span><br><span style=font-size:small>Have questions? We've got answers.</span></a></div></li><li class="header-social-wrap ml-md-auto"><div style=padding-right:20px class="header-social-inner-wrap element-social-inner-wrap social-show-label-false social-style-filled"><a class=mega-menu-link href=https://altinitydbworkspace.slack.com/join/shared_invite/zt-1togw9b4g-N0ZOXQyEyPCBh_7IEHUjdw#/shared-invite/email><span style=border-radius:24px;padding-top:.3em;padding-bottom:.3em;padding-left:1em;padding-right:1em;background-color:#1e9dcf;color:#fff;font-style:normal;font-size:13px;line-height:17px;font-weight:700>Join our community</span>
</a>&nbsp;
<a href=https://altinitydbworkspace.slack.com/join/shared_invite/zt-1togw9b4g-N0ZOXQyEyPCBh_7IEHUjdw#/shared-invite/email aria-label=Slack target=_blank rel="noopener noreferrer" class="social-button header-social-item social-link-custom1" data-positional-element-id=75><span class=social-icon-custom-svg style=max-width:34px><svg viewBox="0 0 36 36" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" d="M7.563 22.747a3.782 3.782.0 11-3.78-3.78h3.78v3.78zm1.906.0a3.782 3.782.0 017.563.0v9.469a3.782 3.782.0 11-7.563.0V22.747zM13.251 7.563a3.782 3.782.0 113.782-3.78v3.78H13.251zm0 1.906a3.781 3.781.0 110 7.563H3.783a3.782 3.782.0 110-7.563h9.468zm15.183 3.782a3.783 3.783.0 113.783 3.782H28.434V13.251zm-1.9.0a3.782 3.782.0 01-7.565.0V3.783a3.782 3.782.0 117.564.0zM22.747 28.434a3.783 3.783.0 11-3.78 3.783V28.434h3.78zm0-1.9a3.782 3.782.0 010-7.565h9.469a3.782 3.782.0 110 7.564z" data-name="Icon simple-slack" id="Icon_simple-slack"/></svg>
</span></a>&nbsp;&nbsp;&nbsp;
<a href=https://github.com/Altinity/ aria-label=GitHub target=_blank rel="noopener noreferrer" class="social-button header-social-item social-link-github has-custom-image" data-positional-element-id=76><img width=500 height=245 src=https://altinity.com/wp-content/uploads/2023/11/github-mark-white.png class="social-icon-image lazyloaded" alt decoding=async loading=lazy style=max-width:24px data-ll-status=loaded><noscript><img width=250 height=245 src=https://altinity.com/wp-content/uploads/2023/11/github-mark-white.png class=social-icon-image alt decoding=async loading=lazy style=max-width:24px></noscript></a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/engines/mergetree-table-engine-family/replacingmergetree/>Return to the regular view of this page</a>.</p></div><h1 class=title>ReplacingMergeTree</h1><div class=lead>ReplacingMergeTree</div><ul><li>1: <a href=#pg-1b0b1062d846cf47875d5cb6db6349be>ReplacingMergeTree does not collapse duplicates</a></li></ul><div class=content><p><a href=https://altinity.com/blog/clickhouse-replacingmergetree-explained-the-good-the-bad-and-the-ugly target=_blank>ReplacingMergeTree</a>
is a powerful ClickHouse MergeTree engine. It is one of the techniques that can be used to guarantee unicity or exactly once delivery in ClickHouse.</p><h2 id=general-operations>General Operations</h2><h3 id=engine-parameters>Engine Parameters</h3><pre tabindex=0><code>Engine = ReplacingMergeTree([version_column],[is_deleted_column])
ORDER BY &lt;list_of_columns&gt;
</code></pre><ul><li><strong>ORDER BY</strong> &ndash; The ORDER BY defines the columns that need to be unique at merge time. Since merge time can not be decided most of the time, the FINAL keyword is required to remove duplicates.</li><li><strong>version_column</strong> &ndash; An monotonically increasing number, which can be based on a timestamp. Used for make sure sure updates are executed in a right order.</li><li><strong>is_deleted_column</strong> (23.2+ see <a href=https://github.com/ClickHouse/ClickHouse/pull/41005 target=_blank>https://github.com/ClickHouse/ClickHouse/pull/41005</a>) &ndash; the column used to delete rows.</li></ul><h3 id=dml-operations>DML operations</h3><ul><li>CREATE &ndash; <code>INSERT INTO t values(..)</code></li><li>READ &ndash; <code>SELECT FROM t final</code></li><li>UPDATE &ndash; <code>INSERT INTO t(..., _version) values (...)</code>, insert with incremented version</li><li>DELETE &ndash; <code>INSERT INTO t(..., _version, is_deleted) values(..., 1)</code></li></ul><h3 id=final>FINAL</h3><p>ClickHouse does not guarantee that merge will fire and replace rows using ReplacingMergeTree logic. <code>FINAL</code> keyword should be used in order to apply merge in a query time. It works reasonably fast when PK filter is used, but maybe slow for <code>SELECT *</code> type of queries:</p><p>See these links for reference:</p><ul><li><a href=../../../altinity-kb-queries-and-syntax/altinity-kb-final-clause-speed/>FINAL clause speed</a></li><li><a href=https://altinity.com/blog/2020/4/14/handling-real-time-updates-in-clickhouse target=_blank>Handling Real-Time Updates in ClickHouse</a></li></ul><p>Since 23.2, profile level <code>final=1</code> can force final automatically, see <a href=https://github.com/ClickHouse/ClickHouse/pull/40945 target=_blank>https://github.com/ClickHouse/ClickHouse/pull/40945</a></p><p>Clickhouse merge parts only in scope of single partition, so if two rows with the same replacing key would land in different partitions, they would <strong>never</strong> be merged in single row. FINAL keyword works in other way, it merge all rows across all partitions. But that behavior can be changed via<code>do_not_merge_across_partitions_select_final</code> setting.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl_part</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>part_key</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplacingMergeTree</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PARTITION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl_part</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optimize_on_insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl_part</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>part_key</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────┴──────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>part_key</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────┴──────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl_part</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>part_key</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────┴──────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl_part</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SETTINGS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>do_not_merge_across_partitions_select_final</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>part_key</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────┴──────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>part_key</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────┴──────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>OPTIMIZE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl_part</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl_part</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>part_key</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────┴──────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌─</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#a40000>─┬─</span><span style=color:#000>value</span><span style=color:#a40000>─┬─</span><span style=color:#000>part_key</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└─────┴───────┴──────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=deleting-the-data>Deleting the data</h3><ul><li>Delete in partition: <code>ALTER TABLE t DELETE WHERE ... in PARTITION 'partition'</code> &ndash; slow and asynchronous, rebuilds the partition</li><li>Filter is_deleted in queries: <code>SELECT ... WHERE is_deleted = 0</code></li><li>Before 23.2, use ROW POLICY to apply a filter automatically: <code>CREATE ROW POLICY delete_masking on t using is_deleted = 0 for ALL;</code></li><li>23.2+ <code>ReplacingMergeTree(version, is_deleted) ORDER BY .. SETTINGS clean_deleted_rows='Always'</code> (see <a href=https://github.com/ClickHouse/ClickHouse/pull/41005 target=_blank>https://github.com/ClickHouse/ClickHouse/pull/41005</a>)</li></ul><p>Other options:</p><ul><li>Partition operations: <code>ALTER TABLE t DROP PARTITION 'partition'</code> &ndash; locks the table, drops full partition only</li><li>Lightwieght delete: <code>DELETE FROM t WHERE ...</code> &ndash; experimental</li></ul><h2 id=use-cases>Use cases</h2><h3 id=last-state>Last state</h3><p>Tested on ClickHouse 23.6 version
FINAL is good in all cases</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>val_1</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UInt32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>val_2</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>val_3</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>val_4</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>val_5</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UUID</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>ts</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DateTime</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ENGINE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplacingMergeTree</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STOP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MERGES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>generateUUIDv4</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>generateUUIDv4</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>generateUUIDv4</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>randomStringUTF8</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>generateUUIDv4</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>┌──</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#a40000>─┐</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>40000000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>│</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>└──────────┘</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=single-key>Single key</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- GROUP BY
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>008</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- ORDER BY LIMIT BY
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>006</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Subquery
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>009</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- FINAL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>008</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=multiple-keys>Multiple keys</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- GROUP BY
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toUInt32</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>043</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>524</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>87</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>502</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- SET optimize_aggregation_in_order=1;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>349</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>94</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>901</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>94</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>506</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>55</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>48</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>562</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- ORDER BY LIMIT BY
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toUInt32</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>　</span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>171</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>524</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>34</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>447</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Subquery
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toUInt32</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>197</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>484</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>72</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>507</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>04</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- SET optimize_aggregation_in_order=1;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>171</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>93</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>465</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>59</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>490</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>55</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>46</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- FINAL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>toUInt32</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>number</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>numbers</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1000000</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>number</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>537</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>357</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>39</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>436</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>28</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=full-table>Full table</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- GROUP BY
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>argMax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val_5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>08</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>600</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>441</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>49</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- SET optimize_aggregation_in_order=1;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>865</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>76</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>677</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>39</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>82</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>526</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>89</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- ORDER BY LIMIT BY
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>39</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>489</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>76</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>353</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Subquery
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>225</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>79</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>65</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>03</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- SET optimize_aggregation_in_order=1;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>924</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>39</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>126</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>79</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>67</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- FINAL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repl_tbl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FINAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FORMAT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Null</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Peak</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>query</span><span style=color:#000;font-weight:700>):</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>834</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MiB</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Elapsed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>314</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Processed</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>38</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>97</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>77</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>million</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>rows</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1b0b1062d846cf47875d5cb6db6349be>1 - ReplacingMergeTree does not collapse duplicates</h1><div class=lead>ReplacingMergeTree does not collapse duplicates</div><p><strong>Hi there, I have a question about replacing merge trees. I have set up a
<a href="https://www.youtube.com/watch?v=THDk625DGsQ" target=_blank>Materialized View</a>
with ReplacingMergeTree table, but even if I call optimize on it, the parts don&rsquo;t get merged. I filled that table yesterday, nothing happened since then. What should I do?</strong></p><p>Merges are eventual and may never happen. It depends on the number of inserts that happened after, the number of parts in the partition, size of parts.
If the total size of input parts are greater than the maximum part size then they will never be merged.</p><p><a href=https://clickhouse.tech/docs/en/operations/settings/merge-tree-settings/#max-bytes-to-merge-at-max-space-in-pool target=_blank>https://clickhouse.tech/docs/en/operations/settings/merge-tree-settings/#max-bytes-to-merge-at-max-space-in-pool</a></p><p><a href=https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replacingmergetree/ target=_blank>https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replacingmergetree/</a>
<em>ReplacingMergeTree is suitable for clearing out duplicate data in the background in order to save space, but it doesn’t guarantee the absence of duplicates.</em></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class="row footer-inner pb-3"><div class=col-12><a href=https://altinity.com target=_blank><img src=/images/general/altinity-logo_horizontal_blue_white.svg width=154 alt=Altinity.com></a></div></div><div class="row footer-inner py-3"><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>PRODUCT</b></li><li class=nav-item><a href=https://altinity.com/managed-clickhouse/ target=_blank>Altinity.Cloud</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-support/ target=_blank>Support for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-training target=_blank>Training for ClickHouse</a></li><li class=nav-item><a href=https://altinity.com/clickhouse-pricing/ target=_blank>Altinity.Cloud Pricing</a></li><li class=nav-item><a href=https://altinity.com/plans-and-features-clickhouse/ target=_blank>Altinity Plans and Features</a></li></ul><div class="d-none d-md-block mb-3"><img decoding=async style="width:60px;display:inline-block;margin:0 10px 0 0" src=/images/general/soc.webp alt="SOC Certified"><img decoding=async style=width:60px;display:inline-block;margin:0 src=/images/general/soc2.webp alt="SOC2 TYPE II Certified"></div></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>RESOURCES</b></li><li class=nav-item><a href=https://altinity.com/blog target=_blank>Blog</a></li><li class=nav-item><a href=https://docs.altinity.com/ target=_blank>Documentation</a></li><li class=nav-item><a href=https://kb.altinity.com/ target=_blank>Knowledge Base</a></li><li class=nav-item><a href=https://altinity.com/releases target=_blank>Altinity Stable Builds</a></li><li class=nav-item><a href=https://hubs.la/Q02pLTV20 target=_blank>Kubernetes Operator</a></li><li class=nav-item><a href=https://altinity.com/ecosystem/ target=_blank>Altinity Open Source Projects</a></li><li class=nav-item><a href=https://altinity.com/events/ target=_blank>Events</a></li></ul></div><div class="col-12 col-sm-6 col-md-3"><ul class="nav flex-column mb-3"><li class=nav-item><b>COMPANY</b></li><li class=nav-item><a href=https://altinity.com/about-us/ target=_blank>About Altinity</a></li><li class=nav-item><a href=https://altinity.com/about-us/press-releases target=_blank>Press Releases</a></li><li class=nav-item><a href=https://altinity.com/partners/ target=_blank>Partners</a></li><li class=nav-item><a href=https://altinity.com/customer-stories/ target=_blank>Customer Stories</a></li><li class=nav-item><a href=https://altinity.com/careers/ target=_blank>Careers</a></li><li class=nav-item><a href=https://altinity.com/contact/ target=_blank>Contact Us</a></li></ul></div><div class="col-12 col-sm-6 col-md-3">Get the latest ClickHouse news straight to your inbox every month.<br><a href=https://altinity.com/newsletter/ target=_blank class="btn btn-primary my-3" style=border-radius:1.5rem>Sign Up</a></div></div></div><div class="row footer-inner pb-3"><div class="col-12 col-sm-6 text-left text-xs-center py-2"><small class=text-white>&copy; 2024 Altinity Inc. Altinity®, Altinity.Cloud®, and Altinity Stable® are registered trademarks of Altinity, Inc. ClickHouse® is a registered trademark of ClickHouse, Inc.; Altinity is not affiliated with or associated with ClickHouse, Inc. All Rights Reserved</small>
<small class=ml-1><a href=https://altinity.com/privacy-policy/ target=_blank>Privacy Policy</a></small></div><div class="col-12 col-sm-6 text-right text-xs-center"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://altinity.com/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=X aria-label=X><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/AltinityDB><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/company/altinity/><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UCE3Y2lDKl_ZfjaCrh62onYA><i class="fab fa-youtube"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/orgs/Altinity/><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Reddit aria-label=Reddit><a class=text-white target=_blank rel="noopener noreferrer" href=https://www.reddit.com/r/Clickhouse/><i class="fab fa-reddit"></i></a></li></ul></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-101676615-2"></script><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/4536206.js></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-101676615-2")</script></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script></body></html>